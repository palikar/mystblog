<!DOCTYPE html>






































<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>The optimal CMake project structure. - Stanislav Arnaudov</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="Abstract I am sure that every C&#43;&#43; programmer has at one point struggled with CMake. There have been multiple times where when I have to start work on some C&#43;&#43; project, I&rsquo;ve to spend a good couple of hours in thinking how should my project structure look like. It&rsquo;s just such a huge hassle to think about all of your CMakeList.txt files and possible libraries and different modules and&hellip; the things that may go wrong with your build system." />
  <meta
    name="author"
    content="[Stanislav Arnaudov]"
  />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="/main.min.css" />

  
  <script
    defer
    src="highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
   
  <link rel="preload" as="image" href="theme.png" />

  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/6f49be4b1398e1936dd765ef2df3a6f2?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="github.svg" />
  
  <link rel="preload" as="image" href="linkedin.svg" />
  
  <link rel="preload" as="image" href="facebook.svg" />
  

  
  <link rel="icon" href="favicon.ico" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.110.0">

  
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158773896-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158773896-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
  
  
  
  <meta property="og:title" content="The optimal CMake project structure." />
<meta property="og:description" content="Description of the project structure I intend to use in the future for my c&#43;&#43; projects." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cmake_structure/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-10T00:00:00+02:00" />
<meta property="article:modified_time" content="2023-02-09T23:51:41+02:00" />

  
  <meta itemprop="name" content="The optimal CMake project structure.">
<meta itemprop="description" content="Description of the project structure I intend to use in the future for my c&#43;&#43; projects."><meta itemprop="datePublished" content="2019-04-10T00:00:00+02:00" />
<meta itemprop="dateModified" content="2023-02-09T23:51:41+02:00" />
<meta itemprop="wordCount" content="3884">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The optimal CMake project structure."/>
<meta name="twitter:description" content="Description of the project structure I intend to use in the future for my c&#43;&#43; projects."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">

    <img alt="" src='/logos/SA.png' width="48" height="48"/>
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold ml-6" href="">
      Stanislav Arnaudov
    </a>

    <a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]">
    </a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/"
        >Home</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/projects"
        >Projects</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/posts/"
        >Posts</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/contact/"
        >Contact</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/palikar "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href=" https://linkedin.com/in/stanislav-arnaudov-37b475164 "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./facebook.svg)"
        href=" https://facebook.com/stanislav.ts "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-4 pt-20 pb-32 dark:prose-invert">
      

<article>
  <header class="mb-20">

    <h1 class="!my-0 pb-2.5">The optimal CMake project structure.</h1>

    
    <div class="text-sm opacity-60">
      
      <time>Apr 10, 2019</time>
      
      
      <span class="mx-1">&middot;</span>
      <span>[Stanislav Arnaudov]</span>
      <span class="mx-1">&middot;</span>
      <span>18 minute read</span>
      <span class="mx-1">&middot;</span>
      <span>3884 words</span>
      
    </div>
    
  </header>

  <section><h2 id="abstract">Abstract</h2>
<p>I am sure that every C++ programmer has at one point struggled with <a href="https://cmake.org/">CMake</a>. There have been multiple times where when I have to start work on some C++ project, I&rsquo;ve to spend a good couple of hours in thinking how should my project structure look like. It&rsquo;s just such a huge hassle to think about all of your CMakeList.txt files and possible libraries and different modules and&hellip; the things that may go wrong with your build system. I&rsquo;ve been meaning to find a good template of a CMake project for a long time and now I think I&rsquo;ve found\created my long wanted gem. In this post, I first want to give a brief overview of my experience with CMake and the present the template project that I have finally settled with.</p>
<h2 id="the-horrible-past-experience">The horrible past experience</h2>
<p>I have bad memories in my early days of dealing with CMake. At the start, I had the impression that a build system should make everything as easy as possible but it seems that often this is not the case. Don&rsquo;t get me wrong. I know build systems do not solve an easy problem, but still. I quickly noticed how there are a lot of people on the internet talking about their way of doing CMake projects. It didn&rsquo;t seem that there wasn&rsquo;t <strong>the</strong> way of doing it. This is generally a good thing. Freedom and doing things <em>your</em> way! But everything comes with a cost. The cost of CMake &ndash; you have no idea what you are supposed to do at the beginning.</p>
<br />
<p>My first experience with a big CMake project was while dealing with legacy code. The structure was similar to the one of <a href="https://github.com/opencv/openc">OpenCV</a>. A big CMakeList.txt file at the top lever with general project settings, a separate file with all of the libraries needed for the project and then a source directory with different modules. Each module is in a folder of its own. The structure of a module: source, include, test, and data directory; a CMakeList.txt file a the root of the module to define all executables and libraries. In all fairness, I still like the structure of the individual modules. The strange thing with the module-system was the way it did dependency resolution. Everything was done &ldquo;manually&rdquo;. It essentially was a big CMake framework that first collected info about every module, looked at the dependencies between them and the needed libraries and then build targets manually for a module by linking explicitly everything that module needed. The whole thing was implemented in a collection of complicated macros. There maps and lists and algorithms and directory traversals and everything you can imagine. The whole thing is written in CMake of course. Legacy code for the win!</p>
<br />
<p>At one point I was considering building a similar system myself for my personal projects. Needless to say, that didn&rsquo;t take off. I wanted to clear up the structure and tightened it around the edges but I didn&rsquo;t have any form of success.</p>
<br />
<p>I browsed some more CMake projects, I watched some talks (see <a href="https://www.youtube.com/watch?v=bsXLMQ6WgIk">Effective CMake</a> Talk by <a href="https://github.com/purpleKarrot">Daniel Pfeifer</a>) and I also tried setting up some thins myself. Nothing adequately clicked with me. CMake was still getting in the way of my C++ programming and it was making it even more painful than it already is. This went on for some while.</p>
<h2 id="the-bright-new-world">The bright new world</h2>
<p>Finally, a very fortunate thing happened. I watched <a href="https://www.youtube.com/watch?v=DHOlsEd0eDE">Applied Best Practices</a> and decided to check out the <a href="https://github.com/lefticus/cpp%5Fbox">repository</a>. The project is created with the idea of being a demonstration of &ldquo;doing things properly&rdquo; in C++. I can agree with this sentiment 100%! I still did some adjustments but I am still grateful that I found this project. Here I will go over the elements of the structure of the template project that I created.</p>
<h3 id="conan">Conan</h3>
<p><a href="https://conan.io/">Conan</a> is one of the numerous attempts to bring the &ldquo;package management world&rdquo; to C++. Package management is one of those things that modern languages just &ldquo;have by default&rdquo; but somehow C++ hasn&rsquo;t exactly caught up. For by CMake structure I wanted at least some attempt to make external dependency management a little bit easier. For this reason, I figured that Conan may be the utility to start my experimentation with &ldquo;C++ package management&rdquo;</p>
<br />
<p>From Conan&rsquo;s website:</p>
<blockquote>
<p>The open-source, decentralized and multi-platform package manager to create and share all your native binaries.</p>
</blockquote>
<p>I won&rsquo;t give (because I can&rsquo;t) a comprehensive guide on Conan here. I believe this here is just enough to set you up and give you some basics of how Conan does its magic.</p>
<p><br /> Conan can be installed through <a href="https://pypi.org/project/conan/">pip</a> and there is an official <a href="https://docs.conan.io/en/latest/introduction.html">get started</a> guide. Once everything is set up properly, you can write your <code>conanfile.txt</code> file in the root directory of your project. This is where all of your dependencies are defined. An example file is:</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">[requires]
        catch2/2.4.0@bincrafters/stable
        spdlog/1.3.1@bincrafters/stable
        fmt/5.3.0@bincrafters/stable
        rang/3.1.0@rang/stable
        clara/1.1.4@bincrafters/stable


[generators]
        cmake
        cmake_find_package
</code></pre><p>It is a <em>conf</em> file with several sections. The dependencies go in the <code>requires</code> node. Usually what to put there is defined on the page of each Conan package. The <code>generators</code> section defines exactly what Conan does and how it builds the dependencies configuration files. Different generators have different effects and use cases. As we are dealing with a CMake project, the <code>cmake</code> and <code>cmake_find_package</code> are enough. With this configuration setup, you can later include several lines of CMake code in your top-level CMakeLists.txt and just call <code>find_package(...)</code> for your dependencies. In theory at least. Sometimes things are a little bit tricky to get them running. If everything is as it is supposed to be, you can execute <code>conan install &lt;path_to_source_directory&gt;</code> in the build directory of the project and all of the dependencies will be fetched and saved in some cache on your machine.</p>
<br />
<p>In my top-level CMakeLists.txt, I have the following lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># First a conan.cmake is downloaded, if not present. This file handles all of the &#34;Conan&#34;-y things with cmake... I guess.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if(<span style="color:#e6db74">NOT</span> <span style="color:#e6db74">EXISTS</span> <span style="color:#e6db74">&#34;${CMAKE_BINARY_DIR}/conan.cmake&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;Downloading conan.cmake from https://github.com/conan-io/cmake-conan&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    file(<span style="color:#e6db74">DOWNLOAD</span>  <span style="color:#e6db74">&#34;https://raw.githubusercontent.com/conan-io/cmake-conan/master/conan.cmake&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;${CMAKE_BINARY_DIR}/conan.cmake&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#f92672">${</span>CMAKE_BINARY_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/conan.cmake</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># This is supposedly the minimal setup in CMake for Conan. After these lines, everything should be ready to use
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>conan_check(<span style="color:#e6db74">REQUIRED</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>conan_cmake_run(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">CONANFILE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">conanfile.txt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">BASIC_SETUP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">CONAN_COMMAND</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">${</span>CONAN_CMD<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">CMAKE_TARGETS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">BUILD</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">missing</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#f92672">${</span>CMAKE_BINARY_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/conanbuildinfo.cmake</span>) <span style="color:#75715e"># conanbuildinfo.cmake is file generated by the cmake generator.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>conan_basic_setup()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This sets up everything and at some later point I can just use something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>find_package(<span style="color:#e6db74">clara</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This includes all of the CMake targets defined for <a href="https://github.com/catchorg/Clara">Clara</a>. We can later effortlessly link agings them when defining our executable for example.</p>
<h3 id="top-level-cmakelist-dot-txt">Top level CMakeList.txt</h3>
<p>With Conan out of the way, I can now proceed to the pure CMake part of my project structure. At the start, I want to layout my key core design goals.</p>
<ul>
<li>Follow <a href="https://www.youtube.com/watch?v=bsXLMQ6WgIk">modern CMake guidelines</a></li>
<li>Ease of use</li>
<li>Modular setup</li>
<li>Not worrying about dependencies between modules</li>
<li>Support for testing</li>
<li>Support for automatics documentation generation</li>
</ul>
<h4 id="folder-structure">Folder structure</h4>
<p>A high-level overview of the my project structure is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>├── cmake
</span></span><span style="display:flex;"><span>│   ├── FindGit.cmake
</span></span><span style="display:flex;"><span>│   ├── git_revision.cmake
</span></span><span style="display:flex;"><span>│   └── safeguards.cmake
</span></span><span style="display:flex;"><span>├── doc
</span></span><span style="display:flex;"><span>│   └── Doxyfile.in
</span></span><span style="display:flex;"><span>├── libs
</span></span><span style="display:flex;"><span>│   └── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   ├── module_1
</span></span><span style="display:flex;"><span>│   ├── module_2
</span></span><span style="display:flex;"><span>│   └── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── templates
</span></span><span style="display:flex;"><span>│   ├── template_app_module
</span></span><span style="display:flex;"><span>│   └── template_lib_module
</span></span><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── conanfile.txt
</span></span><span style="display:flex;"><span>├── create_new_app_module.sh
</span></span><span style="display:flex;"><span>├── create_new_lib_module.sh
</span></span><span style="display:flex;"><span>├── Doxyfile.in
</span></span><span style="display:flex;"><span>├── LICENSE
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>└── README.md
</span></span></code></pre></div><p>Everything comes together at the top-level CMakeLists.txt. This is the main entry point when running <code>cmake &lt;path_to_source_directory&gt;</code>. In the <code>cmake</code> several utility CMake scripts solve several small problems like finding the git version of the host machine and preventing me to build the project inside the source file tree. The <code>Doxyfile.in</code> file contains the basic configuration setup for <a href="http://www.doxygen.nl/">Doxygen</a> which I use for generating documentation. My idea for the <code>libs</code> folder is to encapsulate the external dependencies that are not available through Conan. Of course, for some big dependencies (e.g. OpenCV) this is not really viable but it works like a charm for header-only libraries. The <code>libs/CMakeLists.txt</code> is responsible for loading the libraries in the <code>libs</code> folder. The <code>src</code> directory houses all of the individual sub-modules in separate sub-folders that are included through the <code>src/CMakeLists.txx</code> script. More on the individual modules in a minute. In <code>templates/</code> I have template visions of the two modules that the project can have &ndash; a library or an executable. I want to add a new module to the project, I can use of the scrips at top-level &ndash; <code>create_new_app_module.sh</code> or <code>create_new_lib_module.sh</code> &ndash; to generate the module easily. The <code>create_new_app_module.sh</code> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># root directory of the project</span>
</span></span><span style="display:flex;"><span>DIR<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>readlink -f <span style="color:#e6db74">&#34;</span>$0<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MODULE_NAME<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get the name of the project crom the CMakeLists.txt file</span>
</span></span><span style="display:flex;"><span>PROJECT_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;project(\w*&#34;</span> CMakeLists.txt -o | grep <span style="color:#e6db74">&#34;(.*&#34;</span> -o | cut -c 2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d $DIR/<span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;The module already exists&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># copy the template module and rename its parts</span>
</span></span><span style="display:flex;"><span>cp -r $DIR/templates/template_app_module/ $DIR/src/
</span></span><span style="display:flex;"><span>mv $DIR/src/template_app_module/ $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>mv $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>/include/PROJECT/MODULE_NAME $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>/include/PROJECT/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>mv $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>/include/PROJECT $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span>/include/<span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># expand &#39;MODULE_NAME&#39; to the name of the module in every file of the module&#39;s folder</span>
</span></span><span style="display:flex;"><span>find $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span> -type f -exec sed -i <span style="color:#e6db74">&#34;s/MODULE_NAME/</span><span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">/g&#34;</span> <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span>find $DIR/src/<span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span> -type f -exec sed -i <span style="color:#e6db74">&#34;s/PROJECT_NAME/</span><span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">/g&#34;</span> <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># add the module to the &#39;src/CMakeLists.txt&#39; script</span>
</span></span><span style="display:flex;"><span>LINE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;add_subdirectory(</span><span style="color:#e6db74">${</span>MODULE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! <span style="color:#66d9ef">$(</span>grep $LINE $DIR/src/CMakeLists.txt<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">${</span>LINE<span style="color:#e6db74">}</span> &gt;&gt; $DIR/src/CMakeLists.txt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><p>With this setup, I can simply execute <code>./create_new_app_module.sh executable_1</code> to add a new sub-module with the name &ldquo;executable_1&rdquo;.</p>
<br />
<p>The <code>Makefile</code> is there just so that I can automate some of the things I do regularly in the project folder. Things like rebuilding, creating debug or release builds or cleaning all build folders.</p>
<h4 id="options">Options</h4>
<p>With the general folder structure, we can now go through several parts of the top-level CMakeLists.txt script.</p>
<br />
<p>Near the top of the script, I have the options with which the project can be built. Those are just variables that can be true or false and enable certain conditions for the later parts of the scripts. The options are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>option(<span style="color:#e6db74">ONLY_COVERAGE</span> <span style="color:#e6db74">&#34;Build only tests necessary for coverage&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">LIBCPP</span> <span style="color:#e6db74">&#34;Build with libc++&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">ENABLE_COVERAGE</span> <span style="color:#e6db74">&#34;Enable coverage reporting for gcc/clang&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">ENABLE_ASAN</span> <span style="color:#e6db74">&#34;Enable address sanitizer&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">BUILD_SHARED_LIBS</span> <span style="color:#e6db74">&#34;Enable compilation of shared libraries&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">ENABLE_TESTING</span> <span style="color:#e6db74">&#34;Enable the building of the test&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">ENABLE_CLANG_TIDY</span> <span style="color:#e6db74">&#34;Enable testing with clang-tidy&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">ENABLE_CPPCHECK</span> <span style="color:#e6db74">&#34;Enable testing with cppcheck&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">SIMPLE_BUILD</span> <span style="color:#e6db74">&#34;Build the project as minimally as possible&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">BUILD_DOC</span> <span style="color:#e6db74">&#34;Build the project&#39;s documentation&#34;</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">FORCE_COLORED_OUTPUT</span> <span style="color:#e6db74">&#34;Always produce ANSI-colored output (GNU/Clang only).&#34;</span> <span style="color:#e6db74">TRUE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>option(<span style="color:#e6db74">DEBUG_LOGGING</span> <span style="color:#e6db74">&#34;Enabling debug logging&#34;</span> <span style="color:#e6db74">FALSE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>I think the help strings are pretty self-explanatory so I won&rsquo;t go over each option individually. If you see any of these variables in later snippets, just know that it can be adjusted through the way the cmake is called when building the project. The options are passed as <code>-D</code> arguments to the cmake command. For example, to build with <code>DEBUG_LOGGING</code> enabled, we must call cmake like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cmake .. -DDEBUG_LOGGING<span style="color:#f92672">=</span>TRUE
</span></span></code></pre></div><h4 id="targets">Targets</h4>
<p>Modern CMake is all about targets! The general rule of thumb is not to touch any variable in CMake (like <code>CMAKE_CXX_FLAGS</code>) directly but rather impose some requirements on a certain target. For the most part, the top-level CMakeLists.txt follows this paradigm. Targets can be defines as INTERFACE. This means that they don&rsquo;t produce any build output (neither library nor executable) but rather exist purely to be dependencies of other targets. Interface targets can be used, for example, to &ldquo;contain&rdquo; compile options. When an executable target is defined and it links against one such interface target, all of the compiler options imposed on the interface will also be imposed on the executable. This is my general idea that the CMakeLists.txt is structured around.</p>
<br />
<p>At the start, there are two INTERFACE targets defined &ndash; <code>project_warnings</code> and <code>project_options</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_library(<span style="color:#e6db74">project_warnings</span> <span style="color:#e6db74">INTERFACE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><code>project_warnings</code> is meant to keep track of the flags that instruct the compiler on what warning to report on. <code>project_options</code> is for every other flag that may be passed to the compiler.</p>
<h4 id="flags">Flags</h4>
<p>After the definition of the targets, several checks decide on the compiler flags that are to be used. The significant parts of the &ldquo;building&rdquo; of both targets are given in the following snippets.</p>
<p><br /> For starter, we make sure that we are programming in C++17. C++17 is as good as it gets and it&rsquo;s the current year so, of course, we are going to use it for every personal project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>target_compile_features(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">cxx_std_17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>If coverage is enabled for the build, we set the appropriate flags for the compiler. Notice how we are defining the options only on the targets and not in &ldquo;global scope&rdquo; through the <a href="https://cmake.org/cmake/help/latest/variable/CMAKE%5FLANG%5FFLAGS.html#variable:CMAKE%5F%253CLANG%253E%5FFLAGS">CMAKE_CXX_FLAGS</a> flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">ONLY_COVERAGE</span> <span style="color:#e6db74">OR</span> <span style="color:#e6db74">ENABLE_COVERAGE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_compile_options(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">--coverage</span> <span style="color:#e6db74">-O0</span> <span style="color:#e6db74">-g</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_link_libraries(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">--coverage</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>We do something similar for the address sanitizers of the compiler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">ENABLE_ASAN</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_compile_options(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">-fsanitize=address</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_link_libraries(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">-fsanitize=address</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>While developing in C++, warnings are your friend. The more the better! Warnings can expose lots of tiny mistakes that you can make while writing C++ and in this sense, the compiler is your friend. As long as you tell it to report on the proper warning, of course.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>target_compile_options(<span style="color:#e6db74">project_warnings</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">INTERFACE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wall</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wextra</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wshadow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wnon-virtual-dtor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wold-style-cast</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wcast-align</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wunused</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Woverloaded-virtual</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wpedantic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wconversion</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wsign-conversion</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wnull-dereference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wdouble-promotion</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-Wformat=2</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># some GCC specific warnings. These flags are added only if the used compiler is GCC.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if(<span style="color:#e6db74">&#34;${CMAKE_CXX_COMPILER_ID}&#34;</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;GNU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_compile_options(<span style="color:#e6db74">project_warnings</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">INTERFACE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wmisleading-indentation</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wduplicated-cond</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wlogical-op</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wuseless-cast</span>
</span></span><span style="display:flex;"><span>        )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    target_link_libraries(<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">stdc++fs</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>A colorful output on the terminal is always useful.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if (<span style="color:#f92672">${</span>FORCE_COLORED_OUTPUT<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    if (<span style="color:#e6db74">&#34;${CMAKE_CXX_COMPILER_ID}&#34;</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;GNU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        target_compile_options (<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">-fdiagnostics-color=always</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    elseif (<span style="color:#e6db74">&#34;${CMAKE_CXX_COMPILER_ID}&#34;</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;Clang&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        target_compile_options (<span style="color:#e6db74">project_options</span> <span style="color:#e6db74">INTERFACE</span> <span style="color:#e6db74">-fcolor-diagnostics</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    endif ()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif ()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="extra-tools">Extra tools</h4>
<p>Other than the compiler flags, several other external tools can help you in your C++ development. Many of them can be integrated with CMake. In my project template, I have three of them.</p>
<br />
<p><a href="https://ccache.dev/">CCache</a> is a compiler cache that speeds up recompilation. It is a separate program and you have to have it installed on your system. If this is the case, the following snippet will set up ccache in our build.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>find_program(<span style="color:#e6db74">CCACHE</span> <span style="color:#e6db74">ccache</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if(<span style="color:#e6db74">CCACHE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_COMPILER_LAUNCHER</span> <span style="color:#f92672">${</span>CCACHE<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><br />
<p><a href="http://cppcheck.sourceforge.net/">Cppcheck</a> is a static analysis tool for C++ code. I can help you catch some common mistakes while programming and it even doesn&rsquo;t require you to compile your code. If you have Cppcheck on your system and you&rsquo;ve enabled it in your build, you can use it with CMake like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">ENABLE_CPPCHECK</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    find_program(<span style="color:#e6db74">CPPCHECK</span> <span style="color:#e6db74">cppcheck</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    if(<span style="color:#e6db74">CPPCHECK</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_CPPCHECK</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>CPPCHECK<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">--suppress=syntaxError</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">--enable=all</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">--inconclusive</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">SEND_ERROR</span> <span style="color:#e6db74">&#34;cppcheck requested but executable not found&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><br />
<p><a href="https://clang.llvm.org/extra/clang-tidy/">Clang-Tidy</a> is yet another tool for static analysis of C++ code. It can catch different set ot errors than cppcheck. As with the warnings, the more things the tools can tell us about our code, the better. The CMake integration is, again, possible and trivial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">ENABLE_CLANG_TIDY</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    find_program(<span style="color:#e6db74">CLANGTIDY</span> <span style="color:#e6db74">clang-tidy</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    if(<span style="color:#e6db74">CLANGTIDY</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_CLANG_TIDY</span> <span style="color:#f92672">${</span>CLANGTIDY<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">SEND_ERROR</span> <span style="color:#e6db74">&#34;clang-tidy requested but executable not found&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="configurable-header">Configurable header</h4>
<p>In some situations, in your C++ code, you&rsquo;ll need information that is available only in the CMake build. This may include build information, version of the project, <a href="https://en.wikipedia.org/wiki/Endianness">endianness</a> of the host system, a compile-time configuration of some sort, etc. Because of this, I figured out that I may need some sort of a &ldquo;global&rdquo; header file where such things are saved by CMake and accessible in the C++ code. My approach is to have the file <code>src/include/&lt;project_name&gt;/config.hpp.in</code> that will be configured by CMake and every file in the project would be able to include it. On the CMake side of the things, the code looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">PROJECT_VERSION_MAJOR</span> <span style="color:#e6db74">1</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">PROJECT_VERSION_MINOR</span> <span style="color:#e6db74">0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">PROJECT_VERSION_PATCH</span> <span style="color:#e6db74">0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">PROJECT_VERSION</span> <span style="color:#f92672">${</span>PROJECT_VERSION_MAJOR<span style="color:#f92672">}</span><span style="color:#e6db74">.</span><span style="color:#f92672">${</span>PROJECT_VERSION_MINOR<span style="color:#f92672">}</span><span style="color:#e6db74">.</span><span style="color:#f92672">${</span>PROJECT_VERSION_PATCH<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>configure_file (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${PROJECT_SOURCE_DIR}/src/include/${PROJECT_NAME}/config.hpp.in&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${PROJECT_BINARY_DIR}/src/include/${PROJECT_NAME}/config.hpp&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include_directories(<span style="color:#e6db74">&#34;${PROJECT_BINARY_DIR}/src/include&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Using a CMake function like <code>include_directories</code> is generally a bad practice but in this case, just for once, in a &ldquo;global context&rdquo;, I am okay with it. In the <code>config.hpp.in</code> the file we can use all of the variables in the CMake environment to define whatever we want in the C++ code. To access a CMake variable, we use the <code>@&lt;VARIABLE&gt;@</code> syntax. For example, the file can look like something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PROJECT_VERSION_MAJOR @PROJECT_VERSION_MAJOR@
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PROJECT_VERSION_MINOR @PROJECT_VERSION_MINOR@
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PROJECT_VERSION_PATCH @PROJECT_VERSION_PATCH@
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILE_LOGGING 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CONSOLE_LOGGING 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEBUG_LOGGING 1
</span></span></span></code></pre></div><h4 id="documentation-building">Documentation building</h4>
<p>One of my design goals for the project structure was to be able to handle building documentation. I achieve that through a custom target. In CMake we can specify a command to be executed (in the sense on a command on the terminal) and &ldquo;bind&rdquo; is to a <a href="https://stackoverflow.com/questions/2270643/what-is-a-make-target">make target</a> in the final Makefile in the build directory. This means that at the end of the build process, I can execute something like <code>make doc</code> in the build directory to build the documentation for the project. Setting up Doxygen in CMake is not complicated. There is a package that can be included through <code>find_package</code>. This sets several CMake variables that are relevant to Doxygen. The whole setup can be done like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">BUILD_DOC</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    find_package(<span style="color:#e6db74">Doxygen</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    if (<span style="color:#e6db74">DOXYGEN_FOUND</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                SET(<span style="color:#e6db74">DOXYGEN_IN</span> <span style="color:#f92672">${</span>CMAKE_CURRENT_SOURCE_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/doc/Doxyfile.in</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                SET(<span style="color:#e6db74">DOXYGEN_OUT</span> <span style="color:#f92672">${</span>CMAKE_CURRENT_BINARY_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/Doxyfile</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                configure_file(<span style="color:#f92672">${</span>DOXYGEN_IN<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>DOXYGEN_OUT<span style="color:#f92672">}</span> <span style="color:#e6db74">@ONLY</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                add_custom_target(<span style="color:#e6db74">doc</span> <span style="color:#e6db74">ALL</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">COMMAND</span> <span style="color:#f92672">${</span>DOXYGEN_EXECUTABLE<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>DOXYGEN_OUT<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">WORKING_DIRECTORY</span> <span style="color:#f92672">${</span>CMAKE_CURRENT_BINARY_DIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">COMMENT</span> <span style="color:#e6db74">&#34;Buidling Doxygen documentation&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">VERBATIM</span> )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    else (<span style="color:#e6db74">DOXYGEN_FOUND</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                message(<span style="color:#e6db74">&#34;No doxygen binary found on the system.&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>                SET(<span style="color:#f92672">${</span>BUILD_DOC<span style="color:#f92672">}</span> <span style="color:#e6db74">OFF</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    endif ()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="summery">Summery</h4>
<p>At the end of CMakeLists.txt, I&rsquo;ve created a bunch of messages that show exactly hot the project is currently being build. It just prints out the options of the build and whether or not they are active or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>message(<span style="color:#e6db74">&#34;#########################################&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;\t \t Summary&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;#########################################&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Build type:       \t ${CMAKE_BUILD_TYPE}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Install prefix:   \t ${CMAKE_INSTALL_PREFIX}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Testing enabled:  \t ${ENABLE_TESTING}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Clang-tidy:       \t ${ENABLE_CLANG_TIDY}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Cppcheck:         \t ${ENABLE_CPPCHECK}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Compiler:         \t ${CMAKE_CXX_COMPILER_ID}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Sanizizers:       \t ${ENABLE_ASAN}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Shared libs:      \t ${BUILD_SHARED_LIBS}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Build libcpp:     \t ${LIBCPP}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;CCache executable:\t ${CCACHE}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Building doc:     \t ${BUILD_DOC}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;------------------------------------------&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;Version:          \t ${PROJECT_VERSION}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>message(<span style="color:#e6db74">&#34;########################################&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="modules">Modules</h3>
<p>Let&rsquo;s now look at the individual submodules and how are those organized. As said, the <code>src/CMakeLists.txt</code> script includes them all through several calls of the <code>add_subdirectory</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_subdirectory(<span style="color:#e6db74">submodule_1</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">submodule_1</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><br />
<p>The folder structure of each module is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── data
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── project_name
</span></span><span style="display:flex;"><span>│       └── module_name
</span></span><span style="display:flex;"><span>│           └── main.hpp
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── main.cpp
</span></span><span style="display:flex;"><span>└── tests
</span></span><span style="display:flex;"><span>    ├── CMakeLists.txt
</span></span><span style="display:flex;"><span>    └── test_main.cpp
</span></span></code></pre></div><p>The <code>src/</code> directory is meant for the source files as well as the private headers of the module. &ldquo;Private headers&rdquo; means that those won&rsquo;t be visible outside of the project. The public headers are meant to go in the <code>include/</code> directory. There is, however, a small caveat to its subfolder structure. In order to keep everything in my project organize, so that I can keep my sanity, I prefer to include the headers files in the form of:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;&lt;project_name&gt;/&lt;submodule_name&gt;/&lt;header_file&gt;&#34;</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>In my mind, this is the most &ldquo;logical&rdquo; way to include something that is somewhere in the project as there is a clear hierarchy. This can be achieved by having several subfolders in the <code>include/</code> directory. The structure at the end is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"></code></pre></div><br />
<p>The CMakeLists.txt file for the modules is relatively simple. It just has to create a target (a library or executable), set up the include directories and then link it against the necessary other targets. In the top-level CMakeLists.txt, we&rsquo;ve created the two INTERFACE targets <code>project_options</code> and <code>project_warnings</code>. Those are the &ldquo;mandatory&rdquo; ones to link against and every other target can be a one from the external library and\or a different submodule of the project. The whole CMakeLists.txt file looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># setting up sources
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>add_library(<span style="color:#e6db74">submodule_1_lib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">src/src_file_1.cpp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">src/src_file_2.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># setting up include directories
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target_include_directories(<span style="color:#e6db74">submodule_1_lib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PUBLIC</span> <span style="color:#e6db74">include</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># linking against the desired targets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target_link_libraries(<span style="color:#e6db74">submodule_1_lib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">project_options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">project_warnings</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">clara::calra</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#e6db74">submodule_1_lib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PUBLIC_HEADER</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span><span style="color:#e6db74">/</span><span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">RUNTIME</span> <span style="color:#e6db74">DESTINATION</span>       <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">LIBRARY</span> <span style="color:#e6db74">DESTINATION</span>       <span style="color:#f92672">${</span>CMAKE_INSTALL_LIBDIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">INCLUDES</span> <span style="color:#e6db74">DESTINATION</span>      <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span><span style="color:#e6db74">/</span><span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">ARCHIVE</span> <span style="color:#e6db74">DESTINATION</span>       <span style="color:#f92672">${</span>CMAKE_INSTALL_SHAREDSTATEDIR<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The last call to the <code>install</code> function instructs CMake on how to construct the <em>install</em> target of the final Makefile. The function call basically makes all artifacts &ldquo;go to the right place&rdquo;. I think that the most relevant part is that the header files will be copied to the global include directory (e.g. <code>/usr/include/</code>) but the will be put inside a folder with the project&rsquo;s name. In this case, another project can include headers from this project like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;&lt;project_name&gt;/&lt;submodule_name&gt;/&lt;header_file&gt;&gt;</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>which again helps to keep things organized.</p>
<h3 id="testing">Testing</h3>
<p>The final aspect we have to look at is how to enable support for running C++ tests. Thankfully, CMake makes the integration incredibly easy. CMake uses <a href="https://cmake.org/cmake/help/v3.15/manual/ctest.1.html">ctest</a> to discover and run tests I write the tests themselves with <a href="https://github.com/catchorg/Catch2">Catch</a> &ndash; a header-only, test framework for unit-tests. There is a nice startup guide for Catch <a href="https://github.com/catchorg/Catch2/blob/master/docs/tutorial.md">here</a>. The general idea is to create test executables with the help of Catch and then let ctest run them. To enable ctest support in a project its enough to call the <code>enable_testing</code> function in the top CMakeLists.txt file. In there I have:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">ENABLE_TESTING</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    enable_testing()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>In the CMakeLists.txt files, I conditionally add the <code>test/</code> directory of each submodule. In there, there is a different CMakaLists.txt file that sets up the testing for the corresponding module. The script is nothing special and it is very similar to the upper-level one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#e6db74">submodule_1_testThe</span> <span style="color:#e6db74">final</span> <span style="color:#e6db74">aspect</span> <span style="color:#e6db74">we</span> <span style="color:#e6db74">have</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">look</span> <span style="color:#e6db74">at,</span> <span style="color:#e6db74">is</span> <span style="color:#e6db74">how</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">eable</span> <span style="color:#e6db74">support</span> <span style="color:#e6db74">for</span> <span style="color:#e6db74">running</span> <span style="color:#e6db74">C++</span> <span style="color:#e6db74">tests.</span> <span style="color:#e6db74">Thankfully,</span> <span style="color:#e6db74">CMake</span> <span style="color:#e6db74">makes</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">integration</span> <span style="color:#e6db74">incredibly</span> <span style="color:#e6db74">easy.</span> <span style="color:#e6db74">CMake</span> <span style="color:#e6db74">uses</span> <span style="color:#e6db74">[[https://cmake.org/cmake/help/v3.15/manual/ctest.1.html][ctest]]</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">discrover</span> <span style="color:#e6db74">and</span> <span style="color:#e6db74">run</span> <span style="color:#e6db74">tests</span>  <span style="color:#e6db74">I</span> <span style="color:#e6db74">write</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">tests</span> <span style="color:#e6db74">themselves</span> <span style="color:#e6db74">with</span> <span style="color:#e6db74">[[https://github.com/catchorg/Catch2][Catch]]</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">a</span> <span style="color:#e6db74">header-only,</span> <span style="color:#e6db74">test</span> <span style="color:#e6db74">framework</span> <span style="color:#e6db74">for</span> <span style="color:#e6db74">unit-tests.</span> <span style="color:#e6db74">There</span> <span style="color:#e6db74">is</span> <span style="color:#e6db74">a</span> <span style="color:#e6db74">nice</span> <span style="color:#e6db74">start</span> <span style="color:#e6db74">up</span> <span style="color:#e6db74">guide</span> <span style="color:#e6db74">for</span> <span style="color:#e6db74">Catch</span> <span style="color:#e6db74">[[https://github.com/catchorg/Catch2/blob/master/docs/tutorial.md][here]].</span> <span style="color:#e6db74">The</span> <span style="color:#e6db74">genral</span> <span style="color:#e6db74">idea</span> <span style="color:#e6db74">is</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">create</span> <span style="color:#e6db74">test</span> <span style="color:#e6db74">executables</span> <span style="color:#e6db74">with</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">help</span> <span style="color:#e6db74">of</span> <span style="color:#e6db74">Catch</span> <span style="color:#e6db74">and</span> <span style="color:#e6db74">then</span> <span style="color:#e6db74">let</span> <span style="color:#e6db74">ctest</span> <span style="color:#e6db74">run</span> <span style="color:#e6db74">them.</span> <span style="color:#e6db74">To</span> <span style="color:#e6db74">enable</span> <span style="color:#e6db74">ctest</span> <span style="color:#e6db74">support</span> <span style="color:#e6db74">in</span> <span style="color:#e6db74">a</span> <span style="color:#e6db74">project</span> <span style="color:#e6db74">its</span> <span style="color:#e6db74">enough</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">call</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">~enable_testing~</span> <span style="color:#e6db74">function</span> <span style="color:#e6db74">in</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">top</span> <span style="color:#e6db74">CMakeLists.txt</span> <span style="color:#e6db74">file.</span> <span style="color:#e6db74">In</span> <span style="color:#e6db74">there</span> <span style="color:#e6db74">I</span> <span style="color:#e6db74">have:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#+BEGIN_SRC cmake
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">if(ENABLE_TESTING</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    enable_testing()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>In the CMakeLists.txt files I conditionally add the <code>test/</code> directrory of each submodule. In therem, there is a different CMakaLists.txt file that sets up the testing for the corresponding module. The script is nothing special and it is very similar to the upper level one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#e6db74">submodule_1_test</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">submodule_1_test.cpp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">../src/src_file_1.cpp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">../src/src_file_2.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_include_directories(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">_alisp_test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PUBLIC</span> <span style="color:#e6db74">../include</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">../src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">_alisp_test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">project_options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">project_warnings</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">Catch2::Catch2</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#e6db74">CTest</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#e6db74">Catch</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>catch_discover_tests(<span style="color:#e6db74">submodule_1_test</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The last three lines turn this into a &ldquo;test target&rdquo;. The build will thus produce a binary that can be ran and all the tests defined in it will be executed. As ctest was enabled, the whole process boils down to executing <code>make test</code> in the build directrory of the project. submodule_1_test.cpp ../src/src_file_1.cpp ../src/src_file_2.cpp)</p>
<p>target_include_directories(${PROJECT_NAME}_alisp_test PUBLIC ../include PRIVATE ../src)</p>
<p>target_link_libraries(${PROJECT_NAME}_alisp_test PRIVATE project_options project_warnings PUBLIC Catch2::Catch2)</p>
<p>include(CTest) include(Catch) catch_discover_tests(submodule_1_test) #+END_SRC</p>
<p>The last three lines turn this into a &ldquo;test target&rdquo;. The build will thus produce a binary that can be ran and all the tests defined in it will be executed. As ctest was enabled, the whole process boils down to executing <code>make test</code> in the build directory of the project.</p>
<h2 id="conclusion">Conclusion</h2>
<p>So those are my two cents about CMake and project structure. I don&rsquo;t claim to have a lot of experience but I&rsquo;ve done a lot of research in the past year and a half. I&rsquo;ve looked into different projects, read the best practices, read a lot of vague tutorials on the internet and watched the relevant talks. I have thought this several times, but <span class="underline">this</span> time I really think I&rsquo;ve nailed it. I hope that I&rsquo;ve created (mostly stolen) something scalable that will serve me well in my future small to mid-size projects. Whether of not scalability should be of my concern is a completely separate matter 🙂.</p>
<h2 id="references">References</h2>
<ul>
<li>[1] <a href="https://github.com/lefticus/cpp%5Fbox">CPP_BOX</a> is a project by <a href="https://github.com/lefticus">Jason Turner</a>.</li>
<li>[2] <a href="https://vicrucann.github.io/tutorials/quick-cmake-doxygen/">Victoria Rudakova&rsquo;s Post</a></li>
<li>[3] <a href="https://www.youtube.com/watch?v=bsXLMQ6WgIk">Effective CMake</a> Talk by Daniel Pfeifer</li>
<li>[4] <a href="https://www.youtube.com/watch?v=DHOlsEd0eDE">Applied Best Practices</a> Talk by <a href="https://github.com/lefticus">Jason Turner</a></li>
<li>[5] <a href="https://cmake.org/cmake/help/v3.15/manual/ctest.1.html">CMake&rsquo;s documentation</a></li>
</ul>
</section>

  
  


  
  
  <div id="disqus_thread"></div>

<script>

 function readCookie(name)
 {
   var nameEQ = name + "=";
   var ca = document.cookie.split(';');
   for(var i=0;i < ca.length;i++) {
     var c = ca[i];
     while (c.charAt(0)==' ') c = c.substring(1,c.length);
     if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
   }
   return null;
 }

 (function() {
   let cookieValue = readCookie('consent-settings');
   if (cookieValue)
   {
     var consentValue = cookieValue.toString();
     if (consentValue[1] === "1")
     {	    
       const disqusShortname = 'palikar-github-io';
       const script = document.createElement('script');
       script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
       script.setAttribute('data-timestamp', + new Date());
       document.head.appendChild(script);
     }
   }
 })();
 
</script>

  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60">
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="">Stanislav Arnaudov</a>
  </div>
  <a class="link mx-6" href="#cookies" onclick="document.getElementById('consent-notice').style.display = 'block'; ">Cookie Policy</a>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank">Powered by Hugo</a>
  Theme: 
  <a class="link" href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank" >Paper 6</a>
</footer>


    <style>
    #consent-notice {padding: 1rem 1rem; display: none; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #222; color: white;}
    #consent-notice span {margin-right: 1rem;}
    #consent-notice button {cursor: pointer; display: inline-block; width: auto;}
    #consent-notice span a {color: white; text-decoration: underline; text-decoration-color: rgba(255,255,255,0.5);}
    #consent-notice button.btn {margin-left: 0.5rem;}
    #consent-notice button.btn.manage-consent {background: rgba(255,255,255,0.1); font-weight: normal;}
    
    #consent-overlay {position: fixed; left: 0; top: 0; width: 100%; height: 100vh; display: none; background: rgba(0,0,0,0.75); z-index: 999999; overflow: auto; cursor: pointer;}
    #consent-overlay.active {display: flex;}
    #consent-overlay > div {background: white; width: 100%; max-width: 30rem; padding: 1.75rem; margin: auto; cursor: initial;}
    #consent-overlay > div > div {display: flex; align-items: flex-start; margin-bottom: 1rem;}
    #consent-overlay > div > div:last-child {margin: 0;}
    #consent-overlay h3 {padding-top: 0;}
    #consent-overlay input {margin-top: 0.3rem;}
    #consent-overlay label {display: block; color: black; }
    #consent-overlay .btn {margin-right: 0.5rem;}
    #consent-overlay button.btn.save-consent {background: rgba(0,0,0,0.6); font-weight: normal;}

    @media (max-width: 767px) {
        #consent-overlay > div {padding: 1.75rem 1rem;}
        #consent-notice span {display: block; padding-top: 3px; margin-bottom: 1.5rem;}
        #consent-notice button.btn {position: relative; bottom: 4px;}
    }
</style>

<div id="consent-notice">
  <span>We would like to use <a class="manage-consent" href="#manage-consent">third party code</a> to improve the functionality of this website.</span>
  <span><a class="link mx-6" href="/cookies" onclick="document.getElementById('consent-notice').style.display = 'block'; ">More Information</a></span>
  <button class="btn manage-consent">Manage preferences</button>
  <button class="btn deny-consent">Deny</button>
  <button class="btn approve-consent">Allow</button>
</div>

<div id="consent-overlay">
    <div>
        
            <div>
                <input type="checkbox" id="item0" value="1" name="item0"  />
                <label for="item0">
                  <h3>Google Anaytics (functional)</h3>
		  <p>This code gives us insight into the number of people that visit our website, where they are from and what they are clicking on.</p>
                </label>
            </div>
        
            <div>
                <input type="checkbox" id="item1" value="1" name="item1"  />
                <label for="item1">
                  <h3>Disqus Comment service</h3>
		  <p>The code allows to use the Disqus service for comments on the posts</p>
                </label>
            </div>
        
        <div>
            <button id="save-consent" class="btn save-consent" data-consentvalue="00">Save preferences</button>
            <button class="btn approve-consent">Allow all</button>
        </div>
    </div>
</div>
<script>

    const scripts = [];
    scripts[ 0 ] = "/js/ga.js";
    scripts[ 1 ] = "/js/disqus.js";

    function createCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        createCookie(name,"",-1);
    }
    function denyAllConsentScripts() {
        var consentValue = "";
        scripts.forEach(function(){
            consentValue = consentValue + "0";
        });
        acceptSomeConsentScripts(consentValue);
    }
    function acceptAllConsentScripts() {
        var consentValue = "";
        scripts.forEach(function(){
            consentValue = consentValue + "1";
        });
        acceptSomeConsentScripts(consentValue);
    }
    function acceptSomeConsentScripts(consentValue) {
        setConsentInputs(consentValue);
        createCookie('consent-settings',consentValue,31);
        document.getElementById('consent-notice').style.display = 'none';
        document.getElementById('consent-overlay').classList.remove('active');
        loadConsentScripts(consentValue);
    }
    function loadConsentScripts(consentValue) {
        scripts.forEach(function(value,key){
            
            if(consentValue[key]=="1") {
                var s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = value;
                document.body.appendChild(s);
            }
        });
    }
    function setConsentInputs(consentValue) {
        var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
        elements.forEach(function(el,index) {
            if(consentValue[index]=="1") el.checked = true;
            else el.checked = false;
        });
    }
    function setConsentValue() {
        var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
        var consentValue = "";
        elements.forEach(function(el) {
            if(el.checked) consentValue = consentValue + "1";
            else consentValue = consentValue + "0";
        });
        document.getElementById("save-consent").dataset.consentvalue = consentValue;
    }
 
    var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
    elements.forEach(function(el) {
        el.checked = false;
    });

    if(readCookie('consent-settings')) {
        var consentValue = readCookie('consent-settings').toString();
        setConsentInputs(consentValue);
        loadConsentScripts(consentValue);
    } else {
      document.getElementById('consent-notice').style.display = 'block';
    }
 var elements = document.querySelectorAll('.manage-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
            document.getElementById('consent-overlay').classList.toggle('active');
        });
    });
    var elements = document.querySelectorAll('.deny-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
            denyAllConsentScripts();
        });
    });
    var elements = document.querySelectorAll('.approve-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
          acceptAllConsentScripts();
        });
    });
    document.getElementById("save-consent").addEventListener("click",function() {
        setConsentValue();
        acceptSomeConsentScripts(this.dataset.consentvalue);
    });
    document.getElementById("consent-overlay").addEventListener("click",function(e) {
        if (!document.querySelector("#consent-overlay > div").contains(e.target)){
            this.classList.toggle('active');
        }
    });
</script>


    

    


  </body>
</html>
